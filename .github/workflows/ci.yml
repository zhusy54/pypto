name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  pre-commit:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: pre-commit
      uses: pre-commit/action@v3.0.0
      with:
        extra_args: --all-files

  clang-tidy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Fetch base branch for diff
      if: github.event_name == 'pull_request'
      run: git fetch origin ${{ github.base_ref }} --depth=1

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install project and dependencies
      run: |
        python -m pip install --upgrade pip
        pip install nanobind
        pip install -v .[dev]

    - name: Run clang-tidy
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          python tests/lint/clang_tidy.py --jobs=$(nproc) --diff-base=origin/${{ github.base_ref }}
        else
          python tests/lint/clang_tidy.py --jobs=$(nproc)
        fi

  unit-tests:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.10"]

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: true
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install project and dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -v .[dev]

    - name: Test unit tests
      run: pytest tests/ut -v

  system-tests:
    runs-on: [self-hosted, linux, arm64, npu]
    env:
      ASCEND_HOME_PATH: /usr/local/Ascend/cann-8.5.0
    container:
      image: localhost:5000/ci-device-py310:latest
      options: >-
        --privileged
        -v /usr/local/bin/npu-smi:/usr/local/bin/npu-smi:ro
        -v /usr/local/Ascend:/usr/local/Ascend:ro
        -v /dev:/dev
        -e ASCEND_HOME_PATH=/usr/local/Ascend/cann-8.5.0
        -e DEVICE_ID
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Check NPU
        run: |
          npu-smi info

      - name: Install project and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -v .[dev]

      - name: Install ptoas
        run: |
          PTOAS_VERSION=v0.2
          PTOAS_SHA256=2d0a89b6790e6dc5b76b13b005ce75942b91f36dc11009460bed270dd3646887
          curl --fail --location --retry 3 --retry-all-errors \
            https://github.com/zhangstevenunity/PTOAS/releases/download/${PTOAS_VERSION}/ptoas-bin-aarch64.tar.gz \
             -o /tmp/ptoas-bin-aarch64.tar.gz
          echo "${PTOAS_SHA256}  /tmp/ptoas-bin-aarch64.tar.gz" | sha256sum -c -
          mkdir -p $GITHUB_WORKSPACE/ptoas-bin
          tar -xzf /tmp/ptoas-bin-aarch64.tar.gz -C $GITHUB_WORKSPACE/ptoas-bin
          chmod +x $GITHUB_WORKSPACE/ptoas-bin/ptoas
          chmod +x $GITHUB_WORKSPACE/ptoas-bin/bin/ptoas

      - name: Clone simpler repository
        run: git clone https://github.com/ChaoWao/simpler $GITHUB_WORKSPACE/simpler

      - name: Test system tests (first attempt)
        id: test_first_attempt
        continue-on-error: true
        env:
          SIMPLER_ROOT: ${{ github.workspace }}/simpler
          PTOAS_ROOT: ${{ github.workspace }}/ptoas-bin
        run: pytest tests/st -v --device=$DEVICE_ID --forked

      - name: Checkout stable simpler commit on failure
        if: steps.test_first_attempt.outcome == 'failure'
        working-directory: ${{ github.workspace }}/simpler
        run: git checkout b3ed5878fd0aef153d5359c645ecd0b8947ddf8e

      - name: Test system tests (retry with stable version)
        id: test_retry
        if: steps.test_first_attempt.outcome == 'failure'
        env:
          SIMPLER_ROOT: ${{ github.workspace }}/simpler
          PTOAS_ROOT: ${{ github.workspace }}/ptoas-bin
        run: pytest tests/st -v --device=$DEVICE_ID --forked

      - name: Check final test result
        if: steps.test_first_attempt.outcome == 'failure' && steps.test_retry.outcome == 'failure'
        run: exit 1
